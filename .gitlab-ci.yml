stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  IMAGE_TAG_LATEST: $CI_REGISTRY_IMAGE:latest

# Test stage
test:
  stage: test
  image: python:3.11-slim
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install pytest pytest-asyncio pytest-cov
  script:
    - pytest tests/ --cov=src --cov-report=term-missing --cov-report=xml
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  only:
    - merge_requests
    - main
    - develop

# Lint stage
lint:
  stage: test
  image: python:3.11-slim
  before_script:
    - pip install flake8 black isort mypy
  script:
    - flake8 src/ --max-line-length=120 --exclude=__pycache__
    - black --check src/
    - isort --check-only src/
    - mypy src/ --ignore-missing-imports
  only:
    - merge_requests
    - main

# Build Docker image
build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $IMAGE_TAG -t $IMAGE_TAG_LATEST .
    - docker push $IMAGE_TAG
    - docker push $IMAGE_TAG_LATEST
  only:
    - main
    - develop
    - tags

# Deploy to Kubernetes (GitOps)
deploy:staging:
  stage: deploy
  image: bitnami/kubectl:latest
  environment:
    name: staging
    url: https://rag-api-staging.example.com
  before_script:
    - kubectl config use-context $KUBE_CONTEXT_STAGING
  script:
    - |
      kubectl set image deployment/rag-api \
        rag-api=$IMAGE_TAG \
        -n rag-system
    - kubectl rollout status deployment/rag-api -n rag-system
  only:
    - develop

deploy:production:
  stage: deploy
  image: bitnami/kubectl:latest
  environment:
    name: production
    url: https://rag-api.example.com
  before_script:
    - kubectl config use-context $KUBE_CONTEXT_PRODUCTION
  script:
    - |
      kubectl set image deployment/rag-api \
        rag-api=$IMAGE_TAG \
        -n rag-system
    - kubectl rollout status deployment/rag-api -n rag-system
  when: manual
  only:
    - main
    - tags

# GitOps: Update manifests (for ArgoCD/Flux)
gitops:update:
  stage: deploy
  image: alpine/git:latest
  before_script:
    - apk add --no-cache yq
    - git config --global user.email "gitlab-ci@example.com"
    - git config --global user.name "GitLab CI"
  script:
    - |
      git clone $GITOPS_REPO_URL gitops-repo
      cd gitops-repo
      yq eval -i ".spec.template.spec.containers[0].image = \"$IMAGE_TAG\"" k8s/deployment.yaml
      git add k8s/deployment.yaml
      git commit -m "Update RAG API image to $CI_COMMIT_SHORT_SHA"
      git push https://oauth2:$GITOPS_TOKEN@$GITOPS_REPO_URL
  only:
    - main
  when: manual



