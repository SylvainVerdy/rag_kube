<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG System - Interface de Questions</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .question-section {
            margin-bottom: 30px;
        }

        .question-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }

        .question-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .question-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .response-section {
            margin-top: 30px;
            display: none;
        }

        .response-section.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .response-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .response-box h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .response-text {
            line-height: 1.8;
            color: #333;
            white-space: pre-wrap;
        }

        .sources-box {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .sources-box h4 {
            color: #666;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
        }

        .source-item {
            padding: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 14px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            border-left: 4px solid #e74c3c;
            color: #c0392b;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .chat-history {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
        }

        .chat-message.user {
            background: #e3f2fd;
            margin-left: 20%;
        }

        .chat-message.assistant {
            background: #f5f5f5;
            margin-right: 20%;
        }

        .chat-message .role {
            font-weight: 600;
            margin-bottom: 5px;
            color: #667eea;
        }

        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
            transition: all 0.3s;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f0f0;
        }

        .upload-section.dragover {
            border-color: #764ba2;
            background: #e8e8f5;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 10px 0;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            font-size: 14px;
            color: #666;
        }

        .upload-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }

        .upload-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .upload-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .upload-status.uploading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .evaluation-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .evaluation-section h4 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .auto-scores {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .score-item {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .score-item .score-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .score-item .score-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .score-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .manual-rating {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .rating-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .rating-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .rating-btn:hover {
            border-color: #667eea;
            background: #f0f0f0;
        }

        .rating-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .rating-btn.thumbs-up.active {
            background: #4caf50;
            border-color: #4caf50;
        }

        .rating-btn.thumbs-down.active {
            background: #f44336;
            border-color: #f44336;
        }

        .rating-feedback {
            margin-top: 10px;
            display: none;
        }

        .rating-feedback.show {
            display: block;
        }

        .rating-feedback textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
        }

        .rating-submit {
            margin-top: 10px;
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .rating-submit:hover {
            background: #764ba2;
        }

        .rating-success {
            margin-top: 10px;
            padding: 10px;
            background: #d4edda;
            color: #155724;
            border-radius: 5px;
            display: none;
        }

        .rating-success.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Syst√®me RAG</h1>
            <p>Posez vos questions sur vos documents</p>
        </div>

        <div class="content">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('upload')">üìÑ Ajouter des Documents</button>
                <button class="tab" onclick="switchTab('query')">üí¨ Poser une Question</button>
            </div>

            <!-- Upload Tab -->
            <div id="uploadTab" class="tab-content active">
                <div class="upload-section" id="uploadSection">
                    <h3 style="margin-bottom: 15px; color: #667eea;">üì§ Upload de Documents</h3>
                    <p style="margin-bottom: 20px; color: #666;">
                        Ajoutez des documents (PDF, DOCX, TXT) au syst√®me RAG
                    </p>
                    
                    <div class="file-input-wrapper">
                        <input 
                            type="file" 
                            id="fileInput" 
                            class="file-input" 
                            accept=".pdf,.docx,.txt"
                            onchange="handleFileSelect(event)"
                        >
                        <label for="fileInput" class="file-input-label">
                            üìÅ Choisir un fichier
                        </label>
                    </div>

                    <div id="fileInfo" class="file-info" style="display: none;"></div>
                    <div id="uploadStatus" class="upload-status" style="display: none;"></div>

                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="uploadDocument()" id="uploadBtn" disabled>
                            ‚¨ÜÔ∏è Uploader le document
                        </button>
                    </div>
                </div>
            </div>

            <!-- Query Tab -->
            <div id="queryTab" class="tab-content">
            <div class="question-section">
                <label for="question">Votre question :</label>
                <textarea 
                    id="question" 
                    class="question-input" 
                    rows="3" 
                    placeholder="Exemple: Quels sont les avantages mentionn√©s dans le document?"
                ></textarea>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="askQuestion()" id="askBtn">
                        Poser la question
                    </button>
                    <button class="btn btn-secondary" onclick="clearChat()">
                        Effacer
                    </button>
                </div>
            </div>

            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Recherche en cours...</p>
            </div>

            <div id="error" class="error" style="display: none;"></div>

            <div id="response" class="response-section">
                <div class="response-box">
                    <h3>üìù R√©ponse</h3>
                    <div id="responseText" class="response-text"></div>
                    
                    <!-- Evaluation Section -->
                    <div class="evaluation-section" id="evaluationSection" style="display: none;">
                        <h4>üìä √âvaluation</h4>
                        
                        <!-- Auto Scores -->
                        <div id="autoScores" class="auto-scores"></div>
                        
                        <!-- Manual Rating -->
                        <div class="manual-rating">
                            <strong>Votre √©valuation :</strong>
                            <div class="rating-buttons">
                                <button class="rating-btn thumbs-up" onclick="rateResponse('thumbs_up')" id="thumbsUpBtn">
                                    üëç Bonne r√©ponse
                                </button>
                                <button class="rating-btn thumbs-down" onclick="rateResponse('thumbs_down')" id="thumbsDownBtn">
                                    üëé R√©ponse √† am√©liorer
                                </button>
                                <button class="rating-btn" onclick="rateResponse('custom')" id="customRatingBtn">
                                    ‚≠ê Noter (0-5)
                                </button>
                            </div>
                            
                            <div class="rating-feedback" id="ratingFeedback">
                                <textarea id="ratingComment" placeholder="Commentaire optionnel..."></textarea>
                                <div style="margin-top: 10px;">
                                    <label>Note (0-5) :</label>
                                    <input type="number" id="customScore" min="0" max="5" step="0.1" value="3" style="width: 80px; padding: 5px; margin-left: 10px; border: 1px solid #e0e0e0; border-radius: 5px;">
                                </div>
                                <button class="rating-submit" onclick="submitRating()">Envoyer l'√©valuation</button>
                            </div>
                            
                            <div class="rating-success" id="ratingSuccess">
                                ‚úÖ √âvaluation enregistr√©e avec succ√®s !
                            </div>
                        </div>
                    </div>
                    
                    <div class="sources-box">
                        <h4>üìö Sources utilis√©es</h4>
                        <div id="sources"></div>
                    </div>
                </div>
            </div>

            <div id="chatHistory" class="chat-history"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8001';
        let chatHistory = [];
        let selectedFile = null;
        let currentResponseData = null;
        let currentRating = null;

        // Tab switching
        function switchTab(tabName) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'upload') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('uploadTab').classList.add('active');
            } else {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('queryTab').classList.add('active');
            }
        }

        // File selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                const fileInfo = document.getElementById('fileInfo');
                const uploadBtn = document.getElementById('uploadBtn');
                
                // Check file type
                const allowedTypes = ['.pdf', '.docx', '.txt'];
                const fileExt = '.' + file.name.split('.').pop().toLowerCase();
                
                if (!allowedTypes.includes(fileExt)) {
                    fileInfo.innerHTML = `‚ùå Format non support√©. Formats accept√©s: PDF, DOCX, TXT`;
                    fileInfo.style.color = '#e74c3c';
                    uploadBtn.disabled = true;
                    return;
                }
                
                // Show file info
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                fileInfo.innerHTML = `
                    <strong>üìÑ Fichier s√©lectionn√©:</strong> ${file.name}<br>
                    <strong>üìè Taille:</strong> ${fileSizeMB} MB<br>
                    <strong>üìã Type:</strong> ${fileExt.toUpperCase()}
                `;
                fileInfo.style.color = '#333';
                fileInfo.style.display = 'block';
                uploadBtn.disabled = false;
                
                // Clear previous status
                document.getElementById('uploadStatus').style.display = 'none';
            }
        }

        // Upload document
        async function uploadDocument() {
            if (!selectedFile) {
                alert('Veuillez s√©lectionner un fichier');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            const uploadStatus = document.getElementById('uploadStatus');
            const fileInfo = document.getElementById('fileInfo');

            // Disable button and show loading
            uploadBtn.disabled = true;
            uploadStatus.style.display = 'block';
            uploadStatus.className = 'upload-status uploading';
            uploadStatus.innerHTML = '‚è≥ Upload en cours...';

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);

                const response = await fetch(`${API_URL}/api/ingest/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erreur lors de l\'upload');
                }

                const result = await response.json();
                
                uploadStatus.className = 'upload-status success';
                uploadStatus.innerHTML = `
                    ‚úÖ ${result.message}<br>
                    üìä ${result.chunks_count} chunks cr√©√©s
                `;

                // Reset file input
                document.getElementById('fileInput').value = '';
                selectedFile = null;
                fileInfo.style.display = 'none';
                uploadBtn.disabled = true;

                // Auto switch to query tab after 2 seconds
                setTimeout(() => {
                    switchTab('query');
                    document.getElementById('question').focus();
                }, 2000);

            } catch (err) {
                uploadStatus.className = 'upload-status error';
                uploadStatus.innerHTML = `‚ùå Erreur: ${err.message}`;
                uploadBtn.disabled = false;
            }
        }

        // Drag and drop
        const uploadSection = document.getElementById('uploadSection');
        
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const fileInput = document.getElementById('fileInput');
                fileInput.files = files;
                handleFileSelect({ target: fileInput });
            }
        });

        async function askQuestion() {
            const questionInput = document.getElementById('question');
            const question = questionInput.value.trim();
            
            if (!question) {
                alert('Veuillez entrer une question');
                return;
            }

            const askBtn = document.getElementById('askBtn');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const response = document.getElementById('response');

            // Afficher le loading
            askBtn.disabled = true;
            loading.style.display = 'block';
            error.style.display = 'none';
            response.classList.remove('show');

            // Ajouter la question √† l'historique
            addToChatHistory('user', question);

            try {
                const response_api = await fetch(`${API_URL}/api/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: question,
                        chat_history: chatHistory.slice(0, -1) // Exclure la question actuelle
                    })
                });

                if (!response_api.ok) {
                    throw new Error(`Erreur ${response_api.status}: ${response_api.statusText}`);
                }

                const data = await response_api.json();

                // Afficher la r√©ponse
                document.getElementById('responseText').textContent = data.answer;
                
                // Afficher les sources
                const sourcesDiv = document.getElementById('sources');
                if (data.sources && data.sources.length > 0) {
                    sourcesDiv.innerHTML = data.sources.map((source, index) => 
                        `<div class="source-item">
                            <strong>Source ${index + 1}:</strong> ${source.content.substring(0, 200)}...
                        </div>`
                    ).join('');
                } else {
                    sourcesDiv.innerHTML = '<p>Aucune source disponible</p>';
                }

                // Afficher l'√©valuation automatique
                displayAutoScores(data.auto_scores, data.trace_id);
                
                // Stocker les donn√©es pour la notation
                currentResponseData = {
                    question: question,
                    answer: data.answer,
                    trace_id: data.trace_id || null,  // Peut √™tre null
                    sources_count: data.sources ? data.sources.length : 0,
                    answer_length: data.answer ? data.answer.length : 0
                };
                
                // Debug: afficher le trace_id dans la console
                if (data.trace_id) {
                    console.log('‚úÖ Trace ID re√ßu:', data.trace_id);
                } else {
                    console.warn('‚ö†Ô∏è Pas de trace_id dans la r√©ponse');
                }

                response.classList.add('show');
                
                // Ajouter la r√©ponse √† l'historique
                addToChatHistory('assistant', data.answer);
                
                // Vider le champ de question
                questionInput.value = '';

            } catch (err) {
                error.textContent = `Erreur: ${err.message}. Assurez-vous que l'API est d√©marr√©e sur le port 8001.`;
                error.style.display = 'block';
            } finally {
                askBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        function addToChatHistory(role, content) {
            chatHistory.push({ role, content });
            
            const chatHistoryDiv = document.getElementById('chatHistory');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            messageDiv.innerHTML = `
                <div class="role">${role === 'user' ? 'üë§ Vous' : 'ü§ñ Assistant'}</div>
                <div>${content}</div>
            `;
            chatHistoryDiv.appendChild(messageDiv);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }

        function clearChat() {
            chatHistory = [];
            document.getElementById('chatHistory').innerHTML = '';
            document.getElementById('question').value = '';
            document.getElementById('response').classList.remove('show');
            document.getElementById('error').style.display = 'none';
        }

        // Permettre d'envoyer avec Enter (Ctrl+Enter pour nouvelle ligne)
        document.getElementById('question').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                askQuestion();
            }
        });

        // Display automatic scores
        function displayAutoScores(autoScores, traceId) {
            const evaluationSection = document.getElementById('evaluationSection');
            const autoScoresDiv = document.getElementById('autoScores');
            
            if (autoScores && Object.keys(autoScores).length > 0) {
                evaluationSection.style.display = 'block';
                
                let scoresHTML = '';
                for (const [name, value] of Object.entries(autoScores)) {
                    const percentage = (value * 100).toFixed(0);
                    const label = name === 'relevance' ? 'Pertinence' : 
                                  name === 'completeness' ? 'Compl√©tude' : 
                                  name.charAt(0).toUpperCase() + name.slice(1);
                    
                    scoresHTML += `
                        <div class="score-item">
                            <div class="score-label">${label}</div>
                            <div class="score-value">${percentage}%</div>
                            <div class="score-bar">
                                <div class="score-bar-fill" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }
                
                autoScoresDiv.innerHTML = scoresHTML;
            } else {
                evaluationSection.style.display = 'none';
            }
        }

        // Rate response
        function rateResponse(type) {
            // Reset all buttons
            document.querySelectorAll('.rating-btn').forEach(btn => btn.classList.remove('active'));
            
            const feedbackDiv = document.getElementById('ratingFeedback');
            const customScoreInput = document.getElementById('customScore');
            
            if (type === 'thumbs_up') {
                document.getElementById('thumbsUpBtn').classList.add('active');
                currentRating = { type: 'thumbs_up', value: 1.0 };
                feedbackDiv.classList.add('show');
                if (customScoreInput) customScoreInput.style.display = 'none';
            } else if (type === 'thumbs_down') {
                document.getElementById('thumbsDownBtn').classList.add('active');
                currentRating = { type: 'thumbs_down', value: 0.0 };
                feedbackDiv.classList.add('show');
                if (customScoreInput) customScoreInput.style.display = 'none';
            } else if (type === 'custom') {
                document.getElementById('customRatingBtn').classList.add('active');
                currentRating = { type: 'custom', value: null }; // R√©initialiser pour custom
                feedbackDiv.classList.add('show');
                if (customScoreInput) customScoreInput.style.display = 'block';
            }
        }

        // Submit rating
        async function submitRating() {
            if (!currentResponseData || !currentRating) {
                alert('Veuillez s√©lectionner une √©valuation');
                return;
            }

            const comment = document.getElementById('ratingComment').value;
            let scoreValue;
            let rawScoreValue; // Valeur brute (0-5) pour l'affichage

            // If custom rating, get the value from input
            if (currentRating.type === 'custom') {
                const customScoreInput = document.getElementById('customScore').value;
                rawScoreValue = parseFloat(customScoreInput);
                if (isNaN(rawScoreValue) || rawScoreValue < 0 || rawScoreValue > 5) {
                    alert('Veuillez entrer une note valide entre 0 et 5');
                    return;
                }
                // Normaliser √† 0-1 pour Langfuse (mais garder la valeur brute pour l'affichage)
                scoreValue = rawScoreValue / 5.0;
            } else {
                // Pour thumbs_up/thumbs_down, utiliser la valeur normalis√©e directement
                scoreValue = currentRating.value; // Utiliser la valeur de currentRating
                rawScoreValue = currentRating.type === 'thumbs_up' ? 5 : 0;
            }

            console.log('üìä Envoi de l\'√©valuation:', {
                type: currentRating.type,
                rawValue: rawScoreValue,
                rawValueType: typeof rawScoreValue,
                normalizedValue: scoreValue,
                normalizedValueType: typeof scoreValue
            });

            try {
                const response = await fetch(`${API_URL}/api/langfuse/score/rag`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        trace_id: currentResponseData.trace_id,
                        answer: currentResponseData.answer,
                        question: currentResponseData.question,
                        sources_count: currentResponseData.sources_count,
                        answer_length: currentResponseData.answer.length,
                        relevance_score: currentRating.type === 'thumbs_up' ? 0.9 : 
                                        currentRating.type === 'thumbs_down' ? 0.2 : scoreValue,
                        completeness_score: currentRating.type === 'thumbs_up' ? 0.9 : 
                                          currentRating.type === 'thumbs_down' ? 0.2 : scoreValue,
                        accuracy_score: scoreValue,
                        comment: comment || undefined,
                        rating_type: currentRating.type,
                        raw_score: rawScoreValue !== null ? rawScoreValue : undefined  // Envoyer la valeur brute si disponible
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Erreur lors de l\'enregistrement de l\'√©valuation');
                }

                const result = await response.json();
                console.log('‚úÖ Score enregistr√©:', result);

                // Show success message with details
                const successDiv = document.getElementById('ratingSuccess');
                successDiv.textContent = result.message || '‚úÖ √âvaluation enregistr√©e avec succ√®s dans Langfuse !';
                successDiv.classList.add('show');
                
                // Reset after 3 seconds
                setTimeout(() => {
                    document.getElementById('ratingSuccess').classList.remove('show');
                    document.querySelectorAll('.rating-btn').forEach(btn => btn.classList.remove('active'));
                    document.getElementById('ratingFeedback').classList.remove('show');
                    document.getElementById('ratingComment').value = '';
                    currentRating = null;
                }, 3000);

            } catch (err) {
                alert(`Erreur: ${err.message}`);
            }
        }
    </script>
</body>
</html>

